# -*- coding: utf-8 -*-
"""
继续同步脚本 - 重试之前失败的股票
"""
import time
from smart_stock_sync import SmartStockSync

def retry_known_failed_stocks():
    """重试已知的失败股票列表"""
    # 这些是之前因为数据库锁表问题失败的股票
    failed_stocks = [
        ("300247", "融捷健康", "20120410"),
        ("300248", "新开普", "20120410"),
        ("300249", "依米康", "20120410"),
        ("300250", "初灵信息", "20120410"),
        ("300251", "光线传媒", "20120410"),
        ("300252", "金信诺", "20120410"),
        ("300253", "卫宁健康", "20120410"),
        ("300254", "仟源医药", "20120410"),
        ("300255", "常山药业", "20120410"),
        ("300256", "星星科技", "20120410"),
        ("300257", "开山股份", "20120410"),
        ("300258", "精锻科技", "20120410"),
        ("300259", "新天科技", "20120410"),
        ("300260", "新莱应材", "20120410"),
        ("300261", "雅本化学", "20120410"),
        ("300263", "隆华科技", "20120410"),
        ("300264", "佳创视讯", "20120410"),
        ("300265", "通光线缆", "20120410"),
        ("300266", "兴源环境", "20120410"),
        ("300267", "尔康制药", "20120410"),
        ("300268", "*ST佳沃", "20120410"),
        ("300269", "联建光电", "20120410"),
        ("300270", "中威电子", "20120410"),
        ("300271", "华宇软件", "20120410"),
        ("300272", "开能健康", "20120410"),
        ("300274", "阳光电源", "20120410"),
        ("300275", "梅安森", "20120410"),
        ("300276", "三丰智能", "20120410"),
        ("300277", "海联讯", "20120410"),
        ("300278", "华昌达", "20120410"),
        ("300279", "和晶科技", "20120410"),
        ("300280", "*ST紫天", "20120410"),
        ("300281", "金明精机", "20120410"),
        ("300283", "温州宏丰", "20120410"),
        ("300284", "苏交科", "20120410"),
        ("300285", "国瓷材料", "20120410"),
        ("300286", "安科瑞", "20120410"),
        ("300287", "飞利信", "20120410"),
        ("300288", "朗玛信息", "20120410"),
        ("300289", "利德曼", "20120410"),
        ("300290", "荣科科技", "20120410"),
        ("300291", "百纳千成", "20120410"),
        ("300292", "吴通控股", "20120410"),
        ("300293", "蓝英装备", "20120410"),
        ("300294", "博雅生物", "20120410"),
        ("300295", "三六五网", "20120410"),
        ("300296", "利亚德", "20120410"),
        ("300298", "三诺生物", "20120410"),
        ("300299", "富春股份", "20120410"),
        ("300300", "ST峡创", "20120410"),
        ("300301", "ST长方", "20120410"),
        ("300302", "同有科技", "20120410"),
        ("300303", "聚飞光电", "20120410"),
        ("300304", "云意电气", "20120410"),
        ("300305", "裕兴股份", "20120410"),
        ("300306", "远方信息", "20120410"),
        ("300307", "慈星股份", "20120410"),
        ("300308", "中际旭创", "20120410"),
        ("300310", "宜通世纪", "20120425"),
        ("300311", "ST任子行", "20120425"),
        ("300313", "*ST天山", "20120425"),
        ("300314", "戴维医疗", "20120508"),
        ("300315", "掌趣科技", "20120511"),
        ("300316", "晶盛机电", "20120511"),
        ("300317", "珈伟新能", "20120511"),
        ("300318", "博晖创新", "20120523"),
        ("300319", "麦捷科技", "20120523"),
        ("300320", "海达股份", "20120601"),
        ("300321", "同大股份", "20120523"),
        ("300322", "硕贝德", "20120608"),
        ("300323", "华灿光电", "20120601"),
        ("300324", "旋极信息", "20120608"),
        ("300326", "ST凯利", "20120613"),
        ("300327", "中颖电子", "20120613"),
        ("300328", "宜安科技", "20120619"),
        ("300329", "海伦钢琴", "20120619"),
        ("300331", "苏大维格", "20120628"),
        ("300332", "天壕能源", "20120628"),
        ("300333", "兆日科技", "20120628"),
        ("300334", "津膜科技", "20120705"),
        ("300335", "迪森股份", "20120710"),
        ("300337", "银邦股份", "20120718"),
        ("300338", "ST开元", "20120726"),
        ("300339", "润和软件", "20120718"),
        ("300340", "科恒股份", "20120726"),
        ("300341", "麦克奥迪", "20120726"),
        ("300342", "天银机电", "20120726"),
        ("300343", "ST联创", "20120801"),
        ("300344", "ST立方", "20120801"),
        ("300345", "华民股份", "20120801"),
        ("300346", "南大光电", "20120807"),
        ("300347", "泰格医药", "20120817"),
        ("300348", "长亮科技", "20120817"),
        ("300349", "金卡智能", "20120817"),
        ("300350", "华鹏飞", "20120821"),
        ("300351", "永贵电器", "20120920"),
        ("300352", "北信源", "20120912"),
        ("300353", "东土科技", "20120927"),
        ("300354", "东华测试", "20120920"),
        ("300355", "蒙草生态", "20120927"),
        ("300357", "我武生物", "20140121"),
        ("300358", "楚天科技", "20140121"),
        ("300359", "全通教育", "20140121"),
        ("300360", "炬华科技", "20140121"),
        ("300363", "博腾股份", "20140129"),
        ("300364", "中文在线", "20150121"),
        ("300365", "恒华科技", "20140123"),
        ("300385", "雪浪环境", "20140626")
    ]
    
    sync_tool = SmartStockSync()
    
    if not sync_tool.syncer.connect_database():
        print("数据库连接失败")
        return
    
    print(f"开始重试 {len(failed_stocks)} 只已知失败的股票")
    print("=" * 50)
    
    success_count = 0
    still_failed = []
    
    try:
        for i, (stock_code, stock_name, list_date) in enumerate(failed_stocks, 1):
            print(f"[{i}/{len(failed_stocks)}] 重试 {stock_code} ({stock_name})")
            
            try:
                if sync_tool.syncer.sync_single_stock(stock_code, stock_name, list_date):
                    success_count += 1
                    print(f"  ✅ 重试成功")
                else:
                    still_failed.append({
                        "code": stock_code,
                        "name": stock_name,
                        "list_date": list_date
                    })
                    print(f"  ❌ 重试仍然失败")
                
                # 每只股票后休息
                time.sleep(3)
                
                # 每10只股票休息更长时间
                if i % 10 == 0:
                    print(f"  💤 已重试 {i} 只股票，休息10秒...")
                    time.sleep(10)
            
            except KeyboardInterrupt:
                print(f"\n⚠️ 用户中断重试")
                break
            except Exception as e:
                still_failed.append({
                    "code": stock_code,
                    "name": stock_name,
                    "list_date": list_date
                })
                print(f"  ❌ 异常: {str(e)[:50]}...")
    
    finally:
        sync_tool.syncer.close()
    
    print("\n" + "=" * 50)
    print(f"🎉 重试完成 - 成功: {success_count}, 仍然失败: {len(still_failed)}")
    
    if still_failed:
        print(f"\n❌ 仍然失败的股票 ({len(still_failed)} 只):")
        for stock in still_failed[:10]:  # 只显示前10个
            print(f"  {stock['code']} ({stock['name']})")
        if len(still_failed) > 10:
            print(f"  ... 还有 {len(still_failed) - 10} 只")
        
        # 更新失败股票文件
        import json
        with open('failed_stocks.json', 'w', encoding='utf-8') as f:
            json.dump(still_failed, f, ensure_ascii=False, indent=2)
        print(f"\n仍然失败的股票已更新到: failed_stocks.json")
    else:
        # 删除失败股票文件
        import os
        if os.path.exists('failed_stocks.json'):
            os.remove('failed_stocks.json')
        print("🎉 所有股票都重试成功了！")

if __name__ == "__main__":
    print("准备重试之前因数据库锁表问题失败的股票...")
    confirm = input("确认开始重试吗？(y/N): ")
    if confirm.lower() not in ['y', 'yes', '是']:
        print("操作已取消")
    else:
        retry_known_failed_stocks()