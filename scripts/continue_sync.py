# -*- coding: utf-8 -*-
"""
ç»§ç»­åŒæ­¥è„šæœ¬ - é‡è¯•ä¹‹å‰å¤±è´¥çš„è‚¡ç¥¨
"""
import time
from smart_stock_sync import SmartStockSync

def retry_known_failed_stocks():
    """é‡è¯•å·²çŸ¥çš„å¤±è´¥è‚¡ç¥¨åˆ—è¡¨"""
    # è¿™äº›æ˜¯ä¹‹å‰å› ä¸ºæ•°æ®åº“é”è¡¨é—®é¢˜å¤±è´¥çš„è‚¡ç¥¨
    failed_stocks = [
        ("300247", "èæ·å¥åº·", "20120410"),
        ("300248", "æ–°å¼€æ™®", "20120410"),
        ("300249", "ä¾ç±³åº·", "20120410"),
        ("300250", "åˆçµä¿¡æ¯", "20120410"),
        ("300251", "å…‰çº¿ä¼ åª’", "20120410"),
        ("300252", "é‡‘ä¿¡è¯º", "20120410"),
        ("300253", "å«å®å¥åº·", "20120410"),
        ("300254", "ä»ŸæºåŒ»è¯", "20120410"),
        ("300255", "å¸¸å±±è¯ä¸š", "20120410"),
        ("300256", "æ˜Ÿæ˜Ÿç§‘æŠ€", "20120410"),
        ("300257", "å¼€å±±è‚¡ä»½", "20120410"),
        ("300258", "ç²¾é”»ç§‘æŠ€", "20120410"),
        ("300259", "æ–°å¤©ç§‘æŠ€", "20120410"),
        ("300260", "æ–°è±åº”æ", "20120410"),
        ("300261", "é›…æœ¬åŒ–å­¦", "20120410"),
        ("300263", "éš†åç§‘æŠ€", "20120410"),
        ("300264", "ä½³åˆ›è§†è®¯", "20120410"),
        ("300265", "é€šå…‰çº¿ç¼†", "20120410"),
        ("300266", "å…´æºç¯å¢ƒ", "20120410"),
        ("300267", "å°”åº·åˆ¶è¯", "20120410"),
        ("300268", "*STä½³æ²ƒ", "20120410"),
        ("300269", "è”å»ºå…‰ç”µ", "20120410"),
        ("300270", "ä¸­å¨ç”µå­", "20120410"),
        ("300271", "åå®‡è½¯ä»¶", "20120410"),
        ("300272", "å¼€èƒ½å¥åº·", "20120410"),
        ("300274", "é˜³å…‰ç”µæº", "20120410"),
        ("300275", "æ¢…å®‰æ£®", "20120410"),
        ("300276", "ä¸‰ä¸°æ™ºèƒ½", "20120410"),
        ("300277", "æµ·è”è®¯", "20120410"),
        ("300278", "åæ˜Œè¾¾", "20120410"),
        ("300279", "å’Œæ™¶ç§‘æŠ€", "20120410"),
        ("300280", "*STç´«å¤©", "20120410"),
        ("300281", "é‡‘æ˜ç²¾æœº", "20120410"),
        ("300283", "æ¸©å·å®ä¸°", "20120410"),
        ("300284", "è‹äº¤ç§‘", "20120410"),
        ("300285", "å›½ç“·ææ–™", "20120410"),
        ("300286", "å®‰ç§‘ç‘", "20120410"),
        ("300287", "é£åˆ©ä¿¡", "20120410"),
        ("300288", "æœ—ç›ä¿¡æ¯", "20120410"),
        ("300289", "åˆ©å¾·æ›¼", "20120410"),
        ("300290", "è£ç§‘ç§‘æŠ€", "20120410"),
        ("300291", "ç™¾çº³åƒæˆ", "20120410"),
        ("300292", "å´é€šæ§è‚¡", "20120410"),
        ("300293", "è“è‹±è£…å¤‡", "20120410"),
        ("300294", "åšé›…ç”Ÿç‰©", "20120410"),
        ("300295", "ä¸‰å…­äº”ç½‘", "20120410"),
        ("300296", "åˆ©äºšå¾·", "20120410"),
        ("300298", "ä¸‰è¯ºç”Ÿç‰©", "20120410"),
        ("300299", "å¯Œæ˜¥è‚¡ä»½", "20120410"),
        ("300300", "STå³¡åˆ›", "20120410"),
        ("300301", "STé•¿æ–¹", "20120410"),
        ("300302", "åŒæœ‰ç§‘æŠ€", "20120410"),
        ("300303", "èšé£å…‰ç”µ", "20120410"),
        ("300304", "äº‘æ„ç”µæ°”", "20120410"),
        ("300305", "è£•å…´è‚¡ä»½", "20120410"),
        ("300306", "è¿œæ–¹ä¿¡æ¯", "20120410"),
        ("300307", "æ…ˆæ˜Ÿè‚¡ä»½", "20120410"),
        ("300308", "ä¸­é™…æ—­åˆ›", "20120410"),
        ("300310", "å®œé€šä¸–çºª", "20120425"),
        ("300311", "STä»»å­è¡Œ", "20120425"),
        ("300313", "*STå¤©å±±", "20120425"),
        ("300314", "æˆ´ç»´åŒ»ç–—", "20120508"),
        ("300315", "æŒè¶£ç§‘æŠ€", "20120511"),
        ("300316", "æ™¶ç››æœºç”µ", "20120511"),
        ("300317", "çˆä¼Ÿæ–°èƒ½", "20120511"),
        ("300318", "åšæ™–åˆ›æ–°", "20120523"),
        ("300319", "éº¦æ·ç§‘æŠ€", "20120523"),
        ("300320", "æµ·è¾¾è‚¡ä»½", "20120601"),
        ("300321", "åŒå¤§è‚¡ä»½", "20120523"),
        ("300322", "ç¡•è´å¾·", "20120608"),
        ("300323", "åç¿å…‰ç”µ", "20120601"),
        ("300324", "æ—‹æä¿¡æ¯", "20120608"),
        ("300326", "STå‡¯åˆ©", "20120613"),
        ("300327", "ä¸­é¢–ç”µå­", "20120613"),
        ("300328", "å®œå®‰ç§‘æŠ€", "20120619"),
        ("300329", "æµ·ä¼¦é’¢ç´", "20120619"),
        ("300331", "è‹å¤§ç»´æ ¼", "20120628"),
        ("300332", "å¤©å£•èƒ½æº", "20120628"),
        ("300333", "å…†æ—¥ç§‘æŠ€", "20120628"),
        ("300334", "æ´¥è†œç§‘æŠ€", "20120705"),
        ("300335", "è¿ªæ£®è‚¡ä»½", "20120710"),
        ("300337", "é“¶é‚¦è‚¡ä»½", "20120718"),
        ("300338", "STå¼€å…ƒ", "20120726"),
        ("300339", "æ¶¦å’Œè½¯ä»¶", "20120718"),
        ("300340", "ç§‘æ’è‚¡ä»½", "20120726"),
        ("300341", "éº¦å…‹å¥¥è¿ª", "20120726"),
        ("300342", "å¤©é“¶æœºç”µ", "20120726"),
        ("300343", "STè”åˆ›", "20120801"),
        ("300344", "STç«‹æ–¹", "20120801"),
        ("300345", "åæ°‘è‚¡ä»½", "20120801"),
        ("300346", "å—å¤§å…‰ç”µ", "20120807"),
        ("300347", "æ³°æ ¼åŒ»è¯", "20120817"),
        ("300348", "é•¿äº®ç§‘æŠ€", "20120817"),
        ("300349", "é‡‘å¡æ™ºèƒ½", "20120817"),
        ("300350", "åé¹é£", "20120821"),
        ("300351", "æ°¸è´µç”µå™¨", "20120920"),
        ("300352", "åŒ—ä¿¡æº", "20120912"),
        ("300353", "ä¸œåœŸç§‘æŠ€", "20120927"),
        ("300354", "ä¸œåæµ‹è¯•", "20120920"),
        ("300355", "è’™è‰ç”Ÿæ€", "20120927"),
        ("300357", "æˆ‘æ­¦ç”Ÿç‰©", "20140121"),
        ("300358", "æ¥šå¤©ç§‘æŠ€", "20140121"),
        ("300359", "å…¨é€šæ•™è‚²", "20140121"),
        ("300360", "ç‚¬åç§‘æŠ€", "20140121"),
        ("300363", "åšè…¾è‚¡ä»½", "20140129"),
        ("300364", "ä¸­æ–‡åœ¨çº¿", "20150121"),
        ("300365", "æ’åç§‘æŠ€", "20140123"),
        ("300385", "é›ªæµªç¯å¢ƒ", "20140626")
    ]
    
    sync_tool = SmartStockSync()
    
    if not sync_tool.syncer.connect_database():
        print("æ•°æ®åº“è¿æ¥å¤±è´¥")
        return
    
    print(f"å¼€å§‹é‡è¯• {len(failed_stocks)} åªå·²çŸ¥å¤±è´¥çš„è‚¡ç¥¨")
    print("=" * 50)
    
    success_count = 0
    still_failed = []
    
    try:
        for i, (stock_code, stock_name, list_date) in enumerate(failed_stocks, 1):
            print(f"[{i}/{len(failed_stocks)}] é‡è¯• {stock_code} ({stock_name})")
            
            try:
                if sync_tool.syncer.sync_single_stock(stock_code, stock_name, list_date):
                    success_count += 1
                    print(f"  âœ… é‡è¯•æˆåŠŸ")
                else:
                    still_failed.append({
                        "code": stock_code,
                        "name": stock_name,
                        "list_date": list_date
                    })
                    print(f"  âŒ é‡è¯•ä»ç„¶å¤±è´¥")
                
                # æ¯åªè‚¡ç¥¨åä¼‘æ¯
                time.sleep(3)
                
                # æ¯10åªè‚¡ç¥¨ä¼‘æ¯æ›´é•¿æ—¶é—´
                if i % 10 == 0:
                    print(f"  ğŸ’¤ å·²é‡è¯• {i} åªè‚¡ç¥¨ï¼Œä¼‘æ¯10ç§’...")
                    time.sleep(10)
            
            except KeyboardInterrupt:
                print(f"\nâš ï¸ ç”¨æˆ·ä¸­æ–­é‡è¯•")
                break
            except Exception as e:
                still_failed.append({
                    "code": stock_code,
                    "name": stock_name,
                    "list_date": list_date
                })
                print(f"  âŒ å¼‚å¸¸: {str(e)[:50]}...")
    
    finally:
        sync_tool.syncer.close()
    
    print("\n" + "=" * 50)
    print(f"ğŸ‰ é‡è¯•å®Œæˆ - æˆåŠŸ: {success_count}, ä»ç„¶å¤±è´¥: {len(still_failed)}")
    
    if still_failed:
        print(f"\nâŒ ä»ç„¶å¤±è´¥çš„è‚¡ç¥¨ ({len(still_failed)} åª):")
        for stock in still_failed[:10]:  # åªæ˜¾ç¤ºå‰10ä¸ª
            print(f"  {stock['code']} ({stock['name']})")
        if len(still_failed) > 10:
            print(f"  ... è¿˜æœ‰ {len(still_failed) - 10} åª")
        
        # æ›´æ–°å¤±è´¥è‚¡ç¥¨æ–‡ä»¶
        import json
        with open('failed_stocks.json', 'w', encoding='utf-8') as f:
            json.dump(still_failed, f, ensure_ascii=False, indent=2)
        print(f"\nä»ç„¶å¤±è´¥çš„è‚¡ç¥¨å·²æ›´æ–°åˆ°: failed_stocks.json")
    else:
        # åˆ é™¤å¤±è´¥è‚¡ç¥¨æ–‡ä»¶
        import os
        if os.path.exists('failed_stocks.json'):
            os.remove('failed_stocks.json')
        print("ğŸ‰ æ‰€æœ‰è‚¡ç¥¨éƒ½é‡è¯•æˆåŠŸäº†ï¼")

if __name__ == "__main__":
    print("å‡†å¤‡é‡è¯•ä¹‹å‰å› æ•°æ®åº“é”è¡¨é—®é¢˜å¤±è´¥çš„è‚¡ç¥¨...")
    confirm = input("ç¡®è®¤å¼€å§‹é‡è¯•å—ï¼Ÿ(y/N): ")
    if confirm.lower() not in ['y', 'yes', 'æ˜¯']:
        print("æ“ä½œå·²å–æ¶ˆ")
    else:
        retry_known_failed_stocks()